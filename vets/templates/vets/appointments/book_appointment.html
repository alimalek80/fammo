{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Book Appointment" %} - {{ clinic.name }} - FAMMO{% endblock %}

{% block extra_head %}
<style>
    .time-slot {
        padding: 0.5rem 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    .time-slot:hover {
        border-color: #6366f1;
        background-color: #eef2ff;
    }
    .time-slot.selected {
        background-color: #6366f1;
        color: white;
        border-color: #6366f1;
    }
    .time-slot.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto max-w-3xl px-4 py-8">
    <!-- Breadcrumb -->
    <nav class="mb-6 text-sm">
        <a href="{% url 'vets:partner_clinics' %}" class="text-indigo-600 hover:underline">{% trans "Clinics" %}</a>
        <span class="mx-2 text-gray-400">/</span>
        <a href="{% url 'vets:clinic_detail' slug=clinic.slug %}" class="text-indigo-600 hover:underline">{{ clinic.name }}</a>
        <span class="mx-2 text-gray-400">/</span>
        <span class="text-gray-600">{% trans "Book Appointment" %}</span>
    </nav>

    <div class="bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-2xl font-bold text-gray-900 mb-2">{% trans "Book an Appointment" %}</h1>
        <p class="text-gray-600 mb-6">{{ clinic.name }} - {{ clinic.address }}, {{ clinic.city }}</p>

        <form method="post" id="appointmentForm">
            {% csrf_token %}
            
            <!-- Select Pet -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    {% trans "Select Pet" %} <span class="text-red-500">*</span>
                </label>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                    {% for pet in pets %}
                    <label class="relative cursor-pointer">
                        <input type="radio" name="pet" value="{{ pet.id }}" class="peer sr-only" required>
                        <div class="p-4 border-2 rounded-lg peer-checked:border-indigo-600 peer-checked:bg-indigo-50 hover:border-gray-300 transition-all">
                            <div class="flex items-center">
                                {% if pet.image %}
                                <img src="{{ pet.image.url }}" alt="{{ pet.name }}" class="w-10 h-10 rounded-full object-cover mr-3">
                                {% else %}
                                <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center mr-3">
                                    <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                    </svg>
                                </div>
                                {% endif %}
                                <div>
                                    <p class="font-medium text-gray-900">{{ pet.name }}</p>
                                    <p class="text-xs text-gray-500">{{ pet.pet_type.name }}</p>
                                </div>
                            </div>
                        </div>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <!-- Select Date -->
            <div class="mb-6">
                <label for="appointment_date" class="block text-sm font-medium text-gray-700 mb-2">
                    {% trans "Select Date" %} <span class="text-red-500">*</span>
                </label>
                <input type="date" 
                       id="appointment_date" 
                       name="appointment_date" 
                       min="{{ today }}"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                       required>
                
                <!-- Working Hours Info -->
                <div class="mt-2 text-sm text-gray-500">
                    <p class="font-medium mb-1">{% trans "Working Hours:" %}</p>
                    <div class="grid grid-cols-2 gap-1 text-xs">
                        {% for wh in working_hours %}
                        <span class="{% if wh.is_closed %}text-red-500{% endif %}">
                            {{ wh.get_day_of_week_display }}:
                            {% if wh.is_closed %}
                                {% trans "Closed" %}
                            {% else %}
                                {{ wh.open_time|time:"H:i" }} - {{ wh.close_time|time:"H:i" }}
                            {% endif %}
                        </span>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Select Time -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    {% trans "Select Time" %} <span class="text-red-500">*</span>
                </label>
                <input type="hidden" id="appointment_time" name="appointment_time" required>
                <div id="timeSlots" class="grid grid-cols-4 sm:grid-cols-6 gap-2">
                    <p class="col-span-full text-gray-500 text-sm">{% trans "Please select a date first" %}</p>
                </div>
            </div>

            <!-- Reason -->
            <div class="mb-6">
                <label for="reason" class="block text-sm font-medium text-gray-700 mb-2">
                    {% trans "Reason for Visit" %}
                </label>
                <select id="reason" name="reason" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">{% trans "Select a reason..." %}</option>
                    {% for r in reasons %}
                    <option value="{{ r.id }}">{{ r.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Custom Reason -->
            <div class="mb-6">
                <label for="reason_text" class="block text-sm font-medium text-gray-700 mb-2">
                    {% trans "Additional Details" %}
                </label>
                <input type="text" 
                       id="reason_text" 
                       name="reason_text" 
                       placeholder="{% trans 'Describe your pet\'s issue...' %}"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>

            <!-- Notes -->
            <div class="mb-6">
                <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">
                    {% trans "Notes for the Clinic" %}
                </label>
                <textarea id="notes" 
                          name="notes" 
                          rows="3"
                          placeholder="{% trans 'Any additional information...' %}"
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            </div>

            <!-- Submit -->
            <div class="flex items-center justify-between">
                <a href="{% url 'vets:clinic_detail' slug=clinic.slug %}" class="text-gray-600 hover:text-gray-800">
                    {% trans "Cancel" %}
                </a>
                <button type="submit" 
                        id="submitBtn"
                        disabled
                        class="px-6 py-3 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">
                    {% trans "Book Appointment" %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('appointment_date');
    const timeSlotsContainer = document.getElementById('timeSlots');
    const timeInput = document.getElementById('appointment_time');
    const submitBtn = document.getElementById('submitBtn');
    
    // Set min date to today
    const today = new Date().toISOString().split('T')[0];
    dateInput.min = today;
    
    dateInput.addEventListener('change', function() {
        const selectedDate = this.value;
        if (!selectedDate) return;
        
        timeSlotsContainer.innerHTML = '<p class="col-span-full text-gray-500 text-sm">{% trans "Loading..." %}</p>';
        timeInput.value = '';
        submitBtn.disabled = true;
        
        // Fetch available slots
        fetch(`{% url 'vets:clinic_available_slots' slug=clinic.slug %}?date=${selectedDate}`)
            .then(response => response.json())
            .then(data => {
                timeSlotsContainer.innerHTML = '';
                
                if (!data.is_open) {
                    timeSlotsContainer.innerHTML = `<p class="col-span-full text-red-500 text-sm">${data.message || '{% trans "Clinic is closed on this day" %}'}</p>`;
                    return;
                }
                
                if (data.slots.length === 0) {
                    timeSlotsContainer.innerHTML = '<p class="col-span-full text-amber-600 text-sm">{% trans "No available slots for this date" %}</p>';
                    return;
                }
                
                data.slots.forEach(slot => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'time-slot';
                    btn.textContent = slot;
                    btn.addEventListener('click', function() {
                        document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
                        this.classList.add('selected');
                        timeInput.value = slot;
                        submitBtn.disabled = false;
                    });
                    timeSlotsContainer.appendChild(btn);
                });
            })
            .catch(error => {
                timeSlotsContainer.innerHTML = '<p class="col-span-full text-red-500 text-sm">{% trans "Error loading slots" %}</p>';
            });
    });
});
</script>
{% endblock %}
